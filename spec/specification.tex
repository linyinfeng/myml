\documentclass{report}

\usepackage[a4paper, margin=2cm]{geometry}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{amssymb}

\allowdisplaybreaks[1]
\newtagform{nowidth}{\llap\bgroup(}{)\egroup}

\newcommand{\theLang}{myml}
\newcommand{\code}{\mathtt}
\newcommand{\backtick}{{}^{\backprime}}
\newcommand{\ruleTag}[1]{\label{#1}\tag{\textsc{#1}}}
\DeclareMathOperator{\domain}{dom}
\DeclareMathOperator{\instantiate}{inst}
\DeclareMathOperator{\freeVariable}{fv}
\DeclareMathOperator{\mostGeneralUnifier}{mgu}
\newcommand{\newVariable}{newvar}
\newcommand{\entails}{\vdash}
\newcommand{\typingRelation}[4]{#1 \entails #2 \;:\; #3 ,\; #4}
\newcommand{\composite}{\circ}

\title{The Definition of \theLang}
\author{Lin Yinfeng}

\begin{document}

\maketitle

\tableofcontents

\chapter{\theLang{} the Calculus}

\section{Syntax}

\subsection{Term}

\begin{align*}
\code{t} \Coloneqq \quad & & \text{term} \\
& \code{\lambda x.\ t} & \text{abstraction} \\
| \quad & \code{t\ t} & \text{application} \\
| \quad & \code{x} & \text{variable} \\
| \quad & \code{let\ x = t\ in\ t} & \text{let-in} \\
| \quad & \code{\{\ \}} & \text{empty record} \\
| \quad & \code{extend(l)} & \text{record extend} \\
| \quad & \code{update(l)} & \text{record update} \\
| \quad & \code{access(l)} & \text{record access} \\
| \quad & \code{[\ ]} & \text{empty match} \\
| \quad & \code{extend(\backtick l)} & \text{match extend} \\
| \quad & \code{update(\backtick l)} & \text{match update} \\
| \quad & \code{\backtick l} & \text{variant creation} \\
| \quad & \code{ref} & \text{reference} \\
| \quad & \code{!} & \text{dereference} \\
| \quad & \code{\coloneqq} & \text{assignment} \\
| \quad & \code{l} & \text{location} \\
| \quad & \code{new} & \text{new}
\end{align*}

\subsection{Derived Form}

Working in progress.

\subsection{Value}

\begin{align*}
\code{v} \Coloneqq \quad & & \text{value} \\
& \code{\lambda x.\ t} & \text{abstraction} \\
| \quad & \code{rv} & \text{record value} \\
| \quad & \code{mv} & \text{match value} \\
| \quad & \code{\backtick l\ v} & \text{variant} \\
| \quad & \code{extend(l)} & \text{record extend 1} \\
| \quad & \code{extend(l)\ v} & \text{record extend 2} \\
| \quad & \code{update(l)} & \text{record update 1} \\
| \quad & \code{update(l)\ v} & \text{record update 2} \\
| \quad & \code{access(l)} & \text{record access} \\
| \quad & \code{extend(\backtick l)} & \text{match extend 1} \\
| \quad & \code{extend(\backtick l)\ v} & \text{match extend 2} \\
| \quad & \code{update(\backtick l)} & \text{match update 1} \\
| \quad & \code{update(\backtick l)\ v} & \text{match update 2} \\
| \quad & \code{\backtick l} & \text{variant creation} \\
| \quad & \code{ref} & \text{reference} \\
| \quad & \code{!} & \text{dereference} \\
| \quad & \code{\coloneqq} & \text{assignment 1} \\
| \quad & \code{\coloneqq\ v} & \text{assignment 2} \\
| \quad & \code{l} & \text{location} \\
| \quad & \code{new} & \text{new}
\end{align*}

\begin{align*}
\code{rv} \Coloneqq \quad & & \text{record value} \\
& \code{\{\}} & \text{empty record} \\
| \quad & \code{extend(l)\ v\ rv} & \text{record extend}
\end{align*}

\begin{align*}
\code{mv} \Coloneqq \quad & & \text{match value} \\
& \code{[\ ]} & \text{empty match} \\
| \quad & \code{extend(\backtick l)\ v\ mv} & \text{match extend}
\end{align*}

\subsection{Type}

\begin{align*}
\code{T, MT} \Coloneqq \quad & & \text{monomorphic type} \\
& \code{X} & \text{type variable} \\
& \code{MT \rightarrow MT} & \text{arrow} \\
& \code{\{\ R\ \}} & \text{record} \\
& \code{[\ R\ ]} & \text{variant} \\
& \code{\mu X.\ MT} & \text{recursive} \\
& \code{Ref\ MT} & \text{reference}
\end{align*}

\begin{align*}
\code{R} \Coloneqq \quad & & \text{row} \\
& \code{\cdot} & \text{empty row} \\
& \code{X} & \text{row variable} \\
& \code{l : P, R} & \text{presence} \\
& \code{\mu X.\ R} & \text{recursive}
\end{align*}

\begin{align*}
\code{P} \Coloneqq \quad & & \text{presence} \\
& \code{Absent} & \text{absent} \\
& \code{Present\ MT} & \text{present} \\
& \code{X} & \text{variable} \\
& \code{X\ MT} & \text{variable with type}
\end{align*}

\begin{align*}
\code{PT} \Coloneqq\quad & & \text{polymorphic type} \\
& \code{MT} & \text{monomorphic type} \\
& \code{\forall\ X :: K.\ PT} & \text{universal qualified}
\end{align*}

\subsection{Kind}

\begin{align*}
\code{K} \Coloneqq \quad & & \text{kind} \\
& \code{*} & \text{proper} \\
& \code{Presence} & \text{presence} \\
& \code{Row} & \text{row} \\
& \code{K \Rightarrow K} & \text{arrow}
\end{align*}

\section{Evaluation}

Evaluation of \theLang{} is defined in small step operational semantic. The relation \(\code{t}\mid\mu \longrightarrow \code{t}\mid\mu\) is the smallest relation satisfying all instances of the following rules.

\usetagform{nowidth}
\begin{gather}
\inferrule
{}
{(\lambda\ \code{x}.\ \code{t}_{12})\ \code{v}_2\mid\mu \longrightarrow [\code{x}\mapsto\code{v}_2]\code{t}_{12} \mid\mu}
\ruleTag{E-AppAbs}
\\
\inferrule
{\code{t}_1\mid\mu \longrightarrow \code{t}'_1\mid\mu'}
{\code{t}_1\ \code{t}_2\mid\mu \longrightarrow \code{t}'_1\ \code{t}_2\mid\mu'}
\ruleTag{E-App1}
\\
\inferrule
{\code{t}_2\mid\mu \longrightarrow \code{t}'_2\mid\mu'}
{\code{v}_1\ \code{t}_2\mid\mu \longrightarrow \code{v}_1\ \code{t}'_2\mid\mu'}
\ruleTag{E-App2}
\\
\inferrule
{}
{\code{let}\ \code{x} = \code{v}_1\ \code{in}\ \code{t}_2\mid\mu \longrightarrow [\code{x}\mapsto\code{v}_1]\code{t}_2\mid\mu}
\ruleTag{E-LetV}
\\
\inferrule
{\code{t}_1\mid\mu \longrightarrow \code{t}'_1\mid\mu'}
{\code{let}\ \code{x} = \code{t}_1\ \code{in}\ \code{t}_2\mid\mu \longrightarrow \code{let}\ \code{x} = \code{t}'_1\ \code{in}\ \code{t}_2\mid\mu'}
\ruleTag{E-Let}
\\
\inferrule
{}
{(\code{extend}(\backtick \code{l}_1)\ \code{v}_1\ \code{mv}_1)\ (\backtick \code{l}_2\ \code{v}_2)\mid\mu\longrightarrow
\code{mv}_1\ (\backtick \code{l}_2\ \code{v}_2)\mid\mu}
\ruleTag{E-Match1}
\\
\inferrule
{}
{(\code{extend}(\backtick \code{l})\ \code{v}_1\ \code{mv}_1)\ (\backtick \code{l}\ \code{v}_2)\mid\mu\longrightarrow
\code{v}_1\ \code{v}_2\mid\mu}
\ruleTag{E-Match2}
\\
\inferrule
{}
{\code{update}(\backtick \code{l}_1)\ \code{v}_1\ (\code{extend}(\backtick \code{l}_2)\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow \\\\
\code{extend}(\backtick \code{l}_2)\ \code{v}_2\ (\code{update}(\backtick \code{l}_1)\ \code{v}_1\ \code{mv}_2)\mid\mu}
\ruleTag{E-MatUpdate1}
\\
\inferrule
{}
{\code{update}(\backtick \code{l})\ \code{v}_1\ (\code{extend}(\backtick \code{l})\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow
(\code{extend}(\backtick \code{l})\ \code{v}_1\ \code{mv}_2)\mid\mu}
\ruleTag{E-MatUpdate2}
\\
\inferrule
{}
{\code{access}(\code{l}_1)\ (\code{extend}(\code{l}_2)\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow
\code{access}(\code{l}_1)\ \code{mv}_2\mid\mu}
\ruleTag{E-RcdAccess1}
\\
\inferrule
{}
{\code{access}(\code{l})\ (\code{extend}(\code{l})\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow
\code{v}_2\mid\mu}
\ruleTag{E-RcdAccess2}
\\
\inferrule
{}
{\code{update}(\code{l}_1)\ \code{v}_1\ (\code{extend}(\code{l}_2)\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow \\\\
\code{extend}(\code{l}_2)\ \code{v}_2\ (\code{update}(\code{l}_1)\ \code{v}_1\ \code{mv}_2)\mid\mu}
\ruleTag{E-RcdUpdate1}
\\
\inferrule
{}
{\code{update}(\code{l})\ \code{v}_1\ (\code{extend}(\code{l})\ \code{v}_2\ \code{mv}_2)\mid\mu\longrightarrow
(\code{extend}(\code{l})\ \code{v}_1\ \code{mv}_2)\mid\mu}
\ruleTag{E-RcdUpdate2}
\\
\inferrule
{\code{l}\notin\domain(\mu)}
{\code{ref}\ \code{v}\mid\mu\longrightarrow\code{l}\mid(\mu, \code{l}\mapsto\code{v})}
\ruleTag{E-Ref}
\\
\inferrule
{\mu(\code{l}) = \code{v}}
{\code{!}\ \code{l}\mid\mu\longrightarrow v\mid\mu}
\ruleTag{E-Deref}
\\
\inferrule
{\code{l}\in\domain(\mu)}
{\code{l}\coloneqq\code{v}\mid\mu\longrightarrow \code{unit}\mid[\code{l}\mapsto\code{v}]\mu}
\ruleTag{E-Assign}
\end{gather}

\subsection{Substitution}

Working in progress.

\section{Typing}

\subsection{Instantiation}

\begin{gather}
\instantiate(\code{MT}) = \code{MT}
\ruleTag{Inst-MT} \\
\instantiate(\code{\forall\ X.\ PT}) = [\code{X}\mapsto\newVariable](\instantiate(\code{PT}))
\ruleTag{Inst-PT}
\end{gather}

\subsection{Generalization}

Working in progress.

% \begin{gather}
% \bar{\Gamma}(\code{MT}) = \forall\ \hat{\code{X}}.\ \code{MT}
% \qquad \hat{\code{X}} = \freeVariable(\code{MT}) \setminus \freeVariable(\Gamma)
% \ruleTag{Gen}
% \end{gather}

\subsection{Typing Relation}

Working in progress.

% \begin{gather}
% \inferrule
% {\code{x}:\code{PT}\in\Gamma \and
%  \code{MT} = \instantiate(\code{PT})}
% {\typingRelation{\Gamma}{\code{x}}{\code{MT}}{[\ ]}}
% \ruleTag{T-Var} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \typingRelation{\sigma_1\Gamma}{\code{t}_2}{\code{MT}_2}{\sigma_2} \\\\
%  \code{MT}_3 = \newVariable \and
%  \sigma_3 = \mostGeneralUnifier(\sigma_2\code{MT}_1, \code{MT}_2\rightarrow\code{MT}_3)}
% {\typingRelation{\Gamma}{\code{t}_1\ \code{t}_2}{\sigma_3\code{MT}_3}{\sigma_3\composite\sigma_2\composite\sigma_1}}
% \ruleTag{T-App} \\
% \inferrule
% {\code{MT}_1 = \newVariable \and
%  \typingRelation{\Gamma,\code{x}:\code{MT}_1}{\code{t}}{\code{MT}_2}{\sigma}}
% {\typingRelation{\Gamma}{\code{\lambda\ x.\ t}}{\sigma\code{MT}_1\rightarrow\code{MT}_2}{\sigma}}
% \ruleTag{T-Abs} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \Gamma' = \sigma_1\Gamma \and
%  \typingRelation{\Gamma', \code{x}:\bar{\Gamma'}(\code{MT}_1)}{\code{t}_2}{\code{MT}_2}{\sigma_2}}
% {\typingRelation{\Gamma}{\code{let}\ \code{x}=\code{t}_1\ \code{in}\ \code{t}_2}{\code{MT}_2}{\sigma_2\composite\sigma_1}}
% \ruleTag{T-Let} \\
% \inferrule
% {\typingRelation{\sigma_{i-1}\sigma_{i-2}\dots\sigma_1\Gamma}{\code{t}_i}{\code{MT}_i}{\sigma_i} \and
%  \code{P}_i = \newVariable}
% {\typingRelation{\Gamma}{\{\ {\code{l}_i = \code{t}_i}^{i\in 1\dots n}\ \}}{\{\ \code{l}_i = \code{P}_i\ (\sigma_{n}\sigma_{n-1}\dots\sigma_{i+1}\code{MT}_i)\ \}}{\sigma_n\composite\sigma_{n-1}\composite\cdots\composite\sigma_1}}
% \ruleTag{T-Rcd} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \typingRelation{\sigma_1\Gamma}{\code{t}_2}{\code{MT}_2}{\sigma_2} \\\\
%  \code{P} = \newVariable \and
%  \code{R} = \newVariable \and
%  \sigma_3 = \mostGeneralUnifier(\sigma_2\code{MT}_1, \{\ \code{l}:\code{P}\mid\code{R}\ \}) \\\\
%  \code{P}' = \newVariable}
% {\typingRelation{\Gamma}{\code{t}_1\ \code{with}\ \{\ \code{l} = \code{t}_2\ \}}{\{\ \code{l}:\code{P}'\ \sigma_3\code{MT}_2\mid\sigma_3\code{R}\ \}}{\sigma_3\composite\sigma_2\composite\sigma_1}}
% \ruleTag{T-RcdExt} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \\\\
%  \code{MT}_2 = \newVariable \and
%  \code{R} = \newVariable \and
%  \sigma_2 = \mostGeneralUnifier(\code{MT}_1, \{\ \code{l}:\code{Present}\ \code{MT}_2\mid\code{R}\ \})}
% {\typingRelation{\Gamma}{\code{t}_1.\code{l}}{\sigma_2\code{MT}_2}{\sigma_2\composite\sigma_1}}
% \ruleTag{T-RcdProj} \\
% \inferrule
% {}
% {\typingRelation{\Gamma}{[\ {\backtick\code{l}_i\ \code{x}_i\rightarrow\code{t}_i}^{i\in 1\dots n}\ ]}{\text{TODO}}{\text{TODO}}}
% \ruleTag{T-Mat} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \code{MT}_3 = \newVariable \and
%  \typingRelation{\sigma_1\Gamma, \code{x}:\code{MT}_3}{\code{t_2}}{\code{MT}_2}{\sigma_2} \\\\
%  \code{P} = \newVariable \and
%  \code{R} = \newVariable \and
%  \sigma_3 = \mostGeneralUnifier(\sigma_2\code{MT}_1, [\ \backtick\code{l}:\code{P}\mid\code{R}\ ]\rightarrow\code{MT}_2) \\\\
%  \code{P}' = \newVariable}
% {\typingRelation{\Gamma}{\code{t}_1\ \code{with}\ [\ \backtick\code{l}\ \code{x}\rightarrow\code{t}_2\ ]}{[\ \backtick\code{l}:\code{P}'\ \sigma_3\sigma_2\code{MT}_3\mid\sigma_3\code{R}\ ]\rightarrow\sigma_3\code{MT}_2}{\sigma_3\composite\sigma_2\composite\sigma_1}}
% \ruleTag{T-MatExt} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \code{R} = \newVariable}
% {\typingRelation{\Gamma}{\backtick\code{l}\ \code{t}_1}{[\ \backtick\code{l}:\code{Present}\ \code{MT}_1\mid\code{R}\ ]}{\sigma_1}}
% \ruleTag{T-Variant} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1}}
% {\typingRelation{\Gamma}{\code{ref}\ \code{t}_1}{\code{Ref}\ \code{MT}_1}{\sigma_1}}
% \ruleTag{T-Ref} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \code{MT}_2 = \newVariable \and
%  \sigma_2 = \mostGeneralUnifier(\code{MT}_1, \code{Ref}\ \code{MT}_2)}
% {\typingRelation{\Gamma}{!\ \code{t}_1}{\sigma_2\code{MT}_2}{\sigma_2\composite\sigma_1}}
% \ruleTag{T-Deref} \\
% \inferrule
% {\typingRelation{\Gamma}{\code{t}_1}{\code{MT}_1}{\sigma_1} \and
%  \typingRelation{\sigma_1\Gamma}{\code{t}_2}{\code{MT}_2}{\sigma_2} \and
%  \sigma_3 = \mostGeneralUnifier(\sigma_2\code{MT}_1, \code{Ref}\ \code{MT}_2)
%  }
% {\typingRelation{\Gamma}{\code{t}_1\coloneqq\code{t}_2}{\code{unit}}{\sigma_3\composite\sigma_2\composite\sigma_3}}
% \ruleTag{T-Assign}
% \end{gather}

\subsection{Most General Unifier}

Working in progress.

\chapter{\theLang{} the Language}

Working in progress.

\end{document}
